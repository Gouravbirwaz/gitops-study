apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-notifications-cm
  namespace: argocd
data:

  # Global context values usable in templates
  context: |
    argocdUrl: "http://localhost:5000"

  # Global subscriptions
  subscriptions: |
    - recipient: gouravbirwaz@gmail.com
      triggers:
        - on-health-degraded
        - on-deployed

    # Email service configuration (Gmail SMTP)
    service.email.gmail: |
      username: $email-username
      password: $email-password
      host: smtp.gmail.com
      port: 587
      from: $email-username

    # Template: Application Health Degraded
    template.email-health-degraded: |
      email:
        subject: "[ArgoCD] {{.app.metadata.name}} health is {{.app.status.health.status}}"
        body: |
          ğŸš¨ Application: {{.app.metadata.name}}
          ğŸ“‚ Namespace: {{.app.metadata.namespace}}
          ğŸ”„ Sync Status: {{.app.status.sync.status}}
          ğŸ“Œ Revision: {{.app.status.sync.revision}}
          â¤ï¸ Health Status: {{.app.status.health.status}}
          ğŸ“ Health Message: {{.app.status.health.message}}
          ğŸ”— Details: {{.context.argocdUrl}}/applications/{{.app.metadata.name}}

    # Template: Application Successfully Deployed
    template.email-deployed: |
      email:
        subject: "[ArgoCD] {{.app.metadata.name}} successfully deployed ğŸ‰"
        body: |
          âœ… Application: {{.app.metadata.name}}
          ğŸ“‚ Namespace: {{.app.metadata.namespace}}
          ğŸ”„ Sync Status: {{.app.status.sync.status}}
          ğŸ“Œ Revision: {{.app.status.sync.revision}}
          â¤ï¸ Health Status: {{.app.status.health.status}}
          â± Finished At: {{ if .app.status.operationState }}{{ .app.status.operationState.finishedAt }}{{ end }}
          ğŸ”— Details: {{.context.argocdUrl}}/applications/{{.app.metadata.name}}

    # Trigger: Send email when health becomes Degraded
    trigger.on-health-degraded: |
      - when: app.status.health.status == 'Degraded'
        send:
          - email-health-degraded

    # Trigger: Send email when sync succeeds AND health is Healthy
    trigger.on-deployed: |
      - when: app.status.operationState.phase == 'Succeeded' and app.status.health.status == 'Healthy'
        send:
          - email-deployed